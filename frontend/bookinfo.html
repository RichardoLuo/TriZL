<!DOCTYPE html>
<html lang="en">

<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <meta http-equiv="X-UA-Compatible" content="ie=edge">
   <title>ç½‘ä¸Šä¹¦åº—</title>
   <link rel="stylesheet" type="text/css" href="index.css">
</head>


<body>
   <div class="header">
      <div class="top-nav">
         <div class="section">
            <div class="nav-show">
               <a href="index.html">Database assignment</a>
            </div>
            <div class="nav-link">
               <a href="shoppingbasket.html">ShoppingBasket</a>
               <a href="login.html" class="login-logout-button">Login</a>
               <a href="createaccount.html">Create Account</a>
               <a href="aboutus.html">AboutUs/Help</a>
            </div>
         </div>
      </div>

      <div class="logo-wrap">
         <div class="section">
            <a href="index.html" class="logo">
               <img src="images/logonew.png" alt="">
            </a>
         </div>
      </div>

      <div class="nav-main">
         <div class="section">
            <div class="nav">
               <a href="search.html">å›¾ä¹¦</a>
               <a href="search.html">ç”µå­ä¹¦</a>
               <a href="search.html">ç½‘ç»œæ–‡å­¦</a>
               <a href="search.html">ä¹¦ç±å‘¨è¾¹</a>
               <a href="search.html">å›¾ä¹¦æ’è¡Œæ¦œ</a>
               <a href="search.html">è¯¦ç»†æœç´¢</a>
            </div>
            <div class="search">
               <img src="images/icon-search.png" alt="">
               <input class="search-input" type="text" placeholder="è¯·è¾“å…¥å…³é”®è¯" onkeydown="huiche(event,4)">
            </div>
         </div>
      </div>
   </div>

   <div class="section">
      <div class="book-top">
         <div class="book-top-content">
            å›¾ä¹¦ä¿¡æ¯>
         </div>
      </div>
      <div class="perbook-info">
         <div class="perbookinfo-brife">
            <div class="perbookinfo-img">
               <img src="images/book1.jpg" alt="images/book1.jpg" class="perbook">
            </div>
            <div class="perbookinfo-content">
               <div class="perbookinfo-name">
                  <h1 class="perbook-name">è®ºä¸Šå•å¦‚ä½•å•æ€</h1>
               </div>
               <div class="perbookinfo-item">
                  <div class="perbookinfo-item-title">
                     <div class="perbookinfo-item-title-content">
                        ä»·æ ¼
                     </div>
                  </div>
                  <div class="perbookinfo-item-content">
                     <span style="float:left;">ï¿¥</span><span class="price-content">100</span>
                  </div>
               </div>
               <div class="perbookinfo-item">
                  <div class="perbookinfo-item-title">
                     <div class="perbookinfo-item-title-content">
                        ä½œè€…
                     </div>
                  </div>
                  <div class="perbookinfo-item-content">
                     <span class="author-content">TheShy</span>
                  </div>
               </div>
               <div class="perbookinfo-item">
                  <div class="perbookinfo-item-title">
                     <div class="perbookinfo-item-title-content">
                        ISBN
                     </div>
                  </div>
                  <div class="perbookinfo-item-content">
                     <span class="isbn-content">ASDASDAKSDLASDIOJ123123JOIASD</span>
                  </div>
               </div>
               <div class="perbookinfo-item">
                  <div class="perbookinfo-item-title">
                     <div class="perbookinfo-item-title-content">
                        å‡ºç‰ˆæ—¶é—´
                     </div>
                  </div>
                  <div class="perbookinfo-item-content">
                     <span class="date-content">2019-1</span>
                  </div>
               </div>
               <div class=dashed-div></div>
               <div class="bookbuy-number">
                  <div class="bookbuy-number-title">
                     <div class="bookbuy-number-content">
                        æ•°é‡
                     </div>
                  </div>
                  <div class="bookbuy-number-content">
                     <input type="number" class="input-number-text" value="1" max="8" min="1" title="è¯·è¾“å…¥è´­ä¹°æ•°é‡"
                        oninput="value=value.replace(/[^\d]/g,'')">
                     <div class="span-crease">
                        <div class="number-increase">
                           ğŸ‘†
                        </div>
                        <div class="number-decrease">
                           ğŸ‘‡
                        </div>
                     </div>
                     <div class="number-unit">
                        æœ¬
                     </div>
                     <div class="number-storage" style="color: gray; margin:5px; float: left;">
                        <span>åº“å­˜</span><span class="storage-number">10</span><span>æœ¬</span>
                     </div>
                     <div class="number-storage" style="color: gray; margin:5px; float: left;">
                        <span>é”€å”®é‡</span><span class="sole-number">10</span><span>æœ¬</span>
                     </div>
                  </div>
               </div>
               <div class="bookbuy-button">
                  <button class='buy-button'>ç«‹å³è´­ä¹°</button>
                  <button class="add-button">åŠ å…¥è´­ç‰©è½¦</button>
               </div>
            </div>
         </div>
         <div class="perbookinfo-all">
            <div class="perbookinfo-all-top">
               <div class="book-top-content">
                  å›¾ä¹¦è¯¦æƒ…
               </div>
            </div>
            <div class="perbookinfo-all-content">
               <h2>å›¾ä¹¦ç®€ä»‹</h2>
               <p>ã€ŠJavaScriptä»å…¥é—¨åˆ°ç²¾é€šã€‹åˆ†ä¸ºä¸‰ç¯‡ï¼šç¬¬ä¸€ç¯‡ä¸ºJavaScriptè¯­æ³•åŸºç¡€ï¼Œä¸»è¦åŒ…æ‹¬JavaScriptç®€ä»‹ã€å¦‚ä½•å®ç°JavaScriptã€æ•°æ®ç±»å‹ã€å˜é‡å’Œå¸¸é‡ã€è¿ç®—ç¬¦ã€è¯­å¥å’Œå‡½æ•°ç­‰å†…å®¹ï¼›ç¬¬äºŒç¯‡ä¸ºJavaScriptå¯¹è±¡ï¼Œä¸»è¦åŒ…æ‹¬å¯¹è±¡ã€æ ¸å¿ƒå¯¹è±¡ã€æ•°ç»„ã€æ­£åˆ™è¡¨è¾¾å¼ã€å¯¹è±¡æ¨¡å‹å’Œäº‹ä»¶é©±åŠ¨ã€çª—å£ä¸æ¡†æ¶ã€æ–‡æ¡£å¯¹è±¡ã€è¡¨å•å¯¹è±¡ç­‰å†…å®¹ï¼›ç¬¬ä¸‰ç¯‡ä¸ºé«˜çº§æŠ€æœ¯ï¼Œä¸»è¦åŒ…æ‹¬BOMä¸­çš„å…¶ä»–å¯¹è±¡ã€æ–‡æ¡£å¯¹è±¡æ¨¡å‹ä»¥åŠAjaxæŠ€æœ¯ç­‰å†…å®¹ã€‚
                  ã€ŠJavaScriptä»å…¥é—¨åˆ°ç²¾é€šã€‹é€‚åˆäºJavaScriptçš„åˆå­¦è€…ä½¿ç”¨ï¼Œä¹Ÿé€‚åˆæœ‰ä¸€å®šJavaScriptåŸºç¡€æƒ³è¿›ä¸€æ­¥æé«˜çš„ç½‘é¡µå¼€å‘è€…ä½¿ç”¨ã€‚
               </p>
            </div>
         </div>


      </div>
   </div>
   <div id="bottom">

   </div>
</body>
<script src="./node_modules/jquery/dist/jquery.min.js"></script>
<script src="./node_modules/jquery/dist/jquery.cookie.min.js"></script>
<script src="./node_modules/jquery/dist/jquery.params.js"></script>
<script src="./js/config.js"></script>
<script src="./js/port.js"></script>
<script>

   $('document').ready(function () {
      //ç™»å½•çŠ¶æ€
      var name = $.cookie("name")
      if (name) {
         $navshow = $('.nav-show')
         $navshow.append('<span style="color: white; padding-left:10px" class="navshow-id"> Welcome!' + "</span>" + `<span style="color: white; padding-left:10px" class="nav-showname">` + name + "</span>");

         $logbutton = $('.login-logout-button')
         $logbutton.text("Logout")
         $logbutton.attr("href", "./bookinfo.html")
         $logbutton.click(function () {
            $.removeCookie("name", { path: './' })
            $.removeCookie("port", { path: '/' })
         });
      }

      //å•†å“ä¿¡æ¯load
      var isbn = $.query.get().isbn
      $.ajax({
         url: serverIP + "/book" + "/isbn/" + isbn,
         type: "GET",
         // data: {
         //    method: "isbn",
         //    id: isbn,   
         // },
         timeout: 30000,
         dataType: "json",
         success: function (data) {
            var data = data.bookList[0]
            console.log(data)
            $("img.perbook").attr("src", data.pirture);
            $("h1.perbook-name").text(data.name);
            $("span.price-content").text(data.price);
            $("span.author-content").text(data.author);
            $("span.isbn-content").text(data.isbn);
            $("span.date-content").text(data.releaseTime);
            $("span.storage-number").text(data.repertory);
            $(".perbookinfo-all-content").find("p").text(data.introduction);
            $("span.sole-number").text(data.soleNum)
         },
         error: function () {
            alert("è¯·æ±‚è¶…æ—¶")
         }
      });


      //ä¿®æ”¹å•†å“æ•°ç›®
      $('.number-increase').click(function () {
         let val = parseInt($("input.input-number-text").val())
         if (val > 7) { return false }
         $("input.input-number-text").val(val + 1)
         console.log("upchange")
      })

      $('.number-decrease').click(function () {
         let val = parseInt($("input.input-number-text").val())
         if (val < 2) { return false }
         $("input.input-number-text").val(val - 1)
         console.log("downchange")
      })

      //è´­ä¹°
      $('button.buy-button').click(function () {
         //è¯·æ±‚ç”¨æˆ·æ•°æ®
         var name = "null";
         var phone = "null";
         var address = "null";
         $.ajax({
            url: serverIP + "/user/" + $(".nav-showname").text(),
            type: "GET",
            timeout: 30000,
            dataType: "json",
            success: function (data) {
               if (data.err) { alert("ç”¨æˆ·ä¿¡æ¯é”™è¯¯") }
               else {
                  name = data.user.name;
                  phone = data.user.phone;
                  address = data.user.address;
                           //æ‹¿ç€isbnå· å’Œæ•°ç›® å»ä¹°
                  var number = parseInt($("span.storage-number").text())
                  var buy = parseInt($("input.input-number-text").val())
                  if (number >= buy) {
                     $.ajax({
                        url: serverIP + "/order",
                        type: "POST",
                        data: {
                           "isbn": $(".isbn-content").text(),
                           "perchaseNum": $(".input-number-text").val(),
                           "customerName": name,
                           "customerPhone": phone,
                           "customerAddr": address
                        },
                        timeout: 30000,
                        dataType: "json",
                        success: function (data) {
                           if (data.err) {
                              alert("è®¢å•å¤±è´¥")
                           } else {
                              // ä¹°åˆ°
                              alert("ä¸‹å•æˆåŠŸ")
                              window.location.href = "./bookinfo.html?isbn=" + $(".isbn-content").text();
                           }
                        },
                        error: function () {
                           alert("è¯·æ±‚è¶…æ—¶")
                        }
                     });
                  } else {
                     alert("è¶…å‡ºåº“å­˜")
                  }
               }
            },
            error: function () {
               alert("è¯·ç™»å½•")
               return;
            }
         });



      })
      //åŠ å…¥è´­ç‰©è½¦
      $('button.add-button').click(function () {
         port = $.cookie("port")
         if (!port) {
            book = new Object()
            book.name = $("h1.perbook-name").text();
            book.number = parseInt($("input.input-number-text").val())
            book.price = $("span.price-content").text();
            book.picture = $("img.perbook").attr("src");
            book.isbn = $("span.isbn-content").text();
            var booklist = []
            booklist.push(book)
         }
         else {
            var booklist = JSON.parse(port);
            for (i = 0; i < booklist.length; i++) {
               if (booklist[i].isbn == $("span.isbn-content").text()) {
                  booklist[i].number += parseInt($("input.input-number-text").val())
                  break;
               }
            }
            if (i == booklist.length) {
               book = new Object()
               book.name = $("h1.perbook-name").text();
               book.number = parseInt($("input.input-number-text").val())
               book.price = $("span.price-content").text();
               book.picture = $("img.perbook").attr("src");
               book.isbn = $("span.isbn-content").text();
               booklist.push(book)
            }
         }
         var str = JSON.stringify(booklist);
         $.cookie("port", str)
         alert("æ·»åŠ è´­ç‰©è½¦æˆåŠŸ")
      })
   })

</script>

</html>